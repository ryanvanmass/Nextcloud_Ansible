---
# Install Docker from the Install Script provided by Docker
  - name: Install Docker
    hosts: localhost
    tasks:
      - name: Download Docker Install Script
        git:
          repo: https://github.com/docker/docker-install
          dest: /root/docker-install
      - name: Install Docker Install Script
        shell: sh /root/docker-install/install.sh

# Download Nextcloud from Docker Hub
  - name: Nextcloud Setup
    hosts: localhost
    tasks:
      - name: Pull Nextcloud from Docker Hub
        shell: docker pull nextcloud
  
# Set up Automatic Backup for Nextcloud Container
  - name: Configure Nextcloud Backup
    hosts: localhost
    tasks:
      - name: Create Log Directory
        file:
          path: /var/log/Nextcloud_Backup
          state: directory
      - name: Create Backup Directory
        file:
          path: /mnt/Backup/Nextcloud
          state: directory
      - name: Copy Backup Service
        shell: cp $PWD/Services/Nextcloud_Backup.service /etc/systemd/system
      - name: Copy Backup Timer
        shell: cp $PWD/Services/Nextcloud_Backup.timer /etc/systemd/system
      - name: Reload Systemd
        systemd:
          daemon_reload: yes
      - name: Enable Backup Timer
        systemd:
          name: Nextcloud_Backup.timer
          enabled: yes
          state: started
          
# Firewall Setup  
  - name: UFW Setup
    hosts: localhost
    tasks:
      - name: Set Default Profiles
        shell: ufw default deny incoming && ufw default allow outgoing
      - name: Allow SSH
        ufw:
          rule: limit
          port: ssh
          proto: tcp
      - name: Allow port 8080 for Nextcloud
        ufw:
          rule: allow
          port: 8080
          proto: tcp
          comment: Allowed for Nextcloud
      - name: Enable UFW
        shell: ufw enable

# Set CoreUtil Playbook to auto run every hour
  - name: CoreUtil Playbook setup
    hosts: localhost
    tasks:
      - name: Copy Service
        shell: cp $PWD/Services/CoreUtil.service /etc/systemd/system
      - name: Copy Timer
        shell: cp $PWD/Services/CoreUtil.timer /etc/systemd/system
      - name: Reload SystemD
        systemd:
          daemon_reload: yes
      - name: Starting the Timer
        systemd:
          name: CoreUtil.timer
          state: started
          enabled: yes
